<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Telegram 3D Mini Games — Single File WebApp</title>
  <!-- Three.js CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r152/three.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/152/examples/js/controls/OrbitControls.min.js"></script>
  <style>
    :root{--bg:#0b1020;--panel:#0f1724;--accent:#ffb86b;color-scheme:dark}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#081022,#07111a);font-family:Inter,Segoe UI,Arial}
    #app{height:100%;display:grid;grid-template-rows:auto 1fr}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:rgba(255,255,255,0.02);backdrop-filter: blur(4px)}
    header h1{font-size:16px;margin:0;color:#fff}
    #menu{display:flex;gap:8px}
    .btn{background:linear-gradient(180deg,rgba(255,255,255,0.03),transparent);color:#fff;padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
    #hud{position:absolute;left:12px;top:64px;color:#fff;z-index:30}
    #container{position:relative;height:100%;}
    canvas{display:block}
    #overlay{position:absolute;right:12px;top:64px;color:#fff;z-index:50;background:linear-gradient(180deg,rgba(255,255,255,0.03),transparent);padding:10px;border-radius:8px}
    #panel{position:absolute;left:50%;transform:translateX(-50%);top:12px;background:rgba(0,0,0,0.35);padding:8px;border-radius:8px;color:#fff;z-index:60}
    #menuGames{display:flex;gap:6px}
    select,input{padding:6px;border-radius:6px;border:none;background:rgba(255,255,255,0.03);color:#fff}
    #instructions{font-size:13px;opacity:0.9;margin-top:6px}
    .small{font-size:13px;opacity:0.85}
    footer{position:absolute;left:12px;bottom:12px;color:#aaa;font-size:13px}
  </style>
</head>
<body>
<div id="app">
  <header>
    <h1>Telegram 3D MiniGames — Single File</h1>
    <div id="menu">
      <div id="menuGames" class="small"></div>
      <button id="resetData" class="btn ghost">Reset Scores</button>
      <button id="openProfile" class="btn">Open Wallet</button>
    </div>
  </header>  <div id="container">
    <div id="panel">
      <label class="small">Select game</label>
      <select id="gameSelect">
        <option value="chicken">Chicken Road (3D)</option>
        <option value="aviator">Mini Aviator</option>
        <option value="spinner">Spinner Jackpot (3D)</option>
        <option value="snake">Snake Royale (3D)</option>
        <option value="bottle">Bottle Flip (3D)</option>
        <option value="jump">Jump Dash</option>
      </select>
      <button id="startBtn" class="btn">Start</button>
      <div id="instructions">Tip: Use arrow keys / tap to move. Works inside Telegram WebApp.</div>
    </div><div id="hud"></div>
<div id="overlay"></div>
<div id="scene-root"></div>
<footer>Single-file — open this HTML in browser (or load as Telegram WebApp)</footer>

  </div>
</div><script>
/* --------------------------- Utility / Globals --------------------------- */
const WIDTH = window.innerWidth, HEIGHT = window.innerHeight - 64;
let renderer, scene, camera, clock, currentGame=null;
const state = {
  coins: Number(localStorage.getItem('tg_coins')||0),
  leaderboards: JSON.parse(localStorage.getItem('tg_leaderboards')||'{}')
};
function saveState(){localStorage.setItem('tg_coins',String(state.coins));localStorage.setItem('tg_leaderboards',JSON.stringify(state.leaderboards));}

/* --------------------------- Init Renderer --------------------------- */
function initThree(){
  const root = document.getElementById('scene-root');
  root.innerHTML='';
  renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.shadowMap.enabled=true;
  root.appendChild(renderer.domElement);
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x0b1220);
  camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
  clock = new THREE.Clock();
}

function resize(){
  if(!renderer) return;
  renderer.setSize(window.innerWidth,window.innerHeight);
  camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix();
}
window.addEventListener('resize', resize);

/* --------------------------- Simple Lighting & Ground --------------------------- */
function addDefaultLights(){
  const hemi = new THREE.HemisphereLight(0xffffff,0x222244,0.6); scene.add(hemi);
  const dir = new THREE.DirectionalLight(0xffffff,0.9); dir.position.set(5,10,7); dir.castShadow=true; scene.add(dir);
}

/* --------------------------- Chicken Road 3D --------------------------- */
class ChickenRoad{
  constructor(){
    this.group = new THREE.Group();
    scene.add(this.group);
    this.speed = 0.12; this.spawnTimer=0; this.lanes=7; this.cars=[]; this.coins=[]; this.score=0; this.gameOver=false;
    this.player = this.makePlayer(); this.group.add(this.player);
    this.makeRoad(); this.cameraTarget=new THREE.Vector3(0,6,8);
    camera.position.set(0,8,12); camera.lookAt(0,0,0);
    this.bindControls();
  }
  makeRoad(){
    const matRoad = new THREE.MeshStandardMaterial({color:0x22222a});
    const road = new THREE.Mesh(new THREE.BoxGeometry(14,0.5,this.lanes*3), matRoad); road.position.set(0,-0.25, (this.lanes-1)); road.receiveShadow=true; this.group.add(road);
    // lane lines
    for(let i=0;i<this.lanes;i++){
      const z = i*3; const line = new THREE.Mesh(new THREE.BoxGeometry(12,0.02,0.12), new THREE.MeshStandardMaterial({emissive:0xffffff})); line.position.set(0,0.01,z); this.group.add(line);
    }
  }
  makePlayer(){
    const g = new THREE.Group();
    const body = new THREE.Mesh(new THREE.SphereGeometry(0.45,16,16), new THREE.MeshStandardMaterial({color:0xffd27f})); body.castShadow=true; body.position.set(0,0.4,0); g.add(body);
    const beak = new THREE.Mesh(new THREE.ConeGeometry(0.12,0.25,8), new THREE.MeshStandardMaterial({color:0xff8a00})); beak.rotation.x=Math.PI/2; beak.position.set(0.32,0.35,0); g.add(beak);
    g.position.set(0,0.25,0);
    return g;
  }
  spawnCar(){
    const lane = Math.floor(Math.random()*this.lanes);
    const dir = Math.random()<0.5? -1:1; const length = 1+Math.random()*2;
    const geom = new THREE.BoxGeometry(length,0.6,1.6);
    const mat = new THREE.MeshStandardMaterial({color: Math.random()*0xffffff});
    const car = new THREE.Mesh(geom, mat); car.castShadow=true; car.position.set(dir*12,0.3,lane*3); car.userData={lane,dir}; this.group.add(car); this.cars.push(car);
  }
  spawnCoin(){
    const lane = Math.floor(Math.random()*this.lanes);
    const coin = new THREE.Mesh(new THREE.CylinderGeometry(0.25,0.25,0.08,16), new THREE.MeshStandardMaterial({emissive:0xffd700})); coin.rotation.x=Math.PI/2; coin.position.set( (Math.random()*10-5), 0.5, lane*3); this.group.add(coin); this.coins.push(coin);
  }
  bindControls(){
    this.input = {left:false,right:false,forward:false,back:false};
    window.addEventListener('keydown',(e)=>{
      if(e.code==='ArrowLeft') this.move(-1);
      if(e.code==='ArrowRight') this.move(1);
      if(e.code==='ArrowUp') this.moveForward();
      if(e.code==='KeyR') this.restart();
    });
    // touch
    let startX=null; window.addEventListener('touchstart', (e)=>{startX=e.touches[0].clientX});
    window.addEventListener('touchend', (e)=>{if(startX===null) return; const dx = e.changedTouches[0].clientX - startX; if(dx<-30) this.move(1); else if(dx>30) this.move(-1); startX=null});
  }
  move(dir){
    // move across lanes (-1 left, +1 right) by changing x
    this.player.position.x += dir*1.75; if(this.player.position.x<-6.5) this.player.position.x=-6.5; if(this.player.position.x>6.5) this.player.position.x=6.5;
  }
  moveForward(){ this.player.position.z += 2; this.score += 1; }
  restart(){ // reset scene
    this.cars.forEach(c=>this.group.remove(c)); this.coins.forEach(c=>this.group.remove(c)); this.cars=[];this.coins=[]; this.score=0; this.player.position.set(0,0.25,0); this.gameOver=false;}
  update(dt){
    if(this.gameOver) return;
    this.spawnTimer+=dt;
    if(Math.random()<0.02) this.spawnCoin();
    if(this.spawnTimer>0.8){this.spawnCar(); this.spawnTimer=0;}
    // cars move
    this.cars.forEach((car,i)=>{
      car.position.x += -car.userData.dir * (0.8 + Math.min(4,this.score*0.02));
      if(Math.abs(car.position.x)>15){ this.group.remove(car); this.cars.splice(i,1); }
      // collision
      const dx = car.position.x - this.player.position.x; const dz = car.position.z - this.player.position.z; if(Math.abs(dx)<1.4 && Math.abs(dz)<1.2){ this.gameOver=true; document.getElementById('overlay').innerText = 'Game Over — press R to restart'; this.saveScore(); }
    });
    // coins
    this.coins.forEach((coin,i)=>{
      coin.rotation.y += 6*dt;
      if(coin.position.distanceTo(this.player.position) < 0.8){ this.group.remove(coin); this.coins.splice(i,1); this.score += 5; state.coins += 1; saveState(); }
    });
    // camera follow
    const target = new THREE.Vector3(this.player.position.x,6,this.player.position.z+8);
    camera.position.lerp(target, 0.08); camera.lookAt(this.player.position.x,0.5,this.player.position.z);
  }
  saveScore(){
    const name = 'player'; const s = this.score; state.leaderboards.chicken = state.leaderboards.chicken || [];
    state.leaderboards.chicken.push({name,score:s,date:new Date().toISOString()}); state.leaderboards.chicken.sort((a,b)=>b.score-a.score); state.leaderboards.chicken = state.leaderboards.chicken.slice(0,10); saveState();
  }
}

/* --------------------------- Mini Aviator (simplified) --------------------------- */
class MiniAviator{
  constructor(){ this.group=new THREE.Group(); scene.add(this.group); this.mult=1; this.running=false; this.over=false; this.startTime=0; this.setupHud(); camera.position.set(0,6,12); }
  setupHud(){ document.getElementById('overlay').innerHTML='Tap to start / click to cashout. Multiplier: <b id="multVal">1.00x</b>'; window.addEventListener('click',()=>{ if(!this.running){this.start();} else this.cashout(); }); }
  start(){ this.running=true; this.startTime=performance.now(); }
  cashout(){ if(!this.running) return; this.running=false; const won = Math.floor(this.mult*10); state.coins += won; saveState(); document.getElementById('overlay').innerText = 'Cashed out x'+this.mult.toFixed(2)+'. +'+won+' coins'; }
  update(dt){ if(this.running){ this.mult += dt*0.5; const crashChance = Math.min(0.003 + this.mult*0.0006, 0.15); if(Math.random() < crashChance*dt*60){ this.running=false; this.over=true; document.getElementById('overlay').innerText = 'Crashed at x'+this.mult.toFixed(2); } document.getElementById('multVal').innerText = this.mult.toFixed(2)+'x'; } }
}

/* --------------------------- Spinner Jackpot --------------------------- */
class Spinner{
  constructor(){ this.group = new THREE.Group(); scene.add(this.group); this.wheel = this.makeWheel(); this.group.add(this.wheel); this.rotSpeed=0; document.getElementById('overlay').innerHTML='Click to spin'; window.addEventListener('click',()=>{ if(this.rotSpeed===0) this.spin(); }); camera.position.set(0,6,10); }
  makeWheel(){ const g = new THREE.Group(); const segments=8; for(let i=0;i<segments;i++){ const seg = new THREE.Mesh(new THREE.BoxGeometry(3,0.2,1.2), new THREE.MeshStandardMaterial({color: new THREE.Color().setHSL(i/segments,0.7,0.5)})); seg.position.set(0,0,1.5); seg.rotation.y = (i/segments)*Math.PI*2; g.add(seg);} g.rotation.x = Math.PI/2; return g; }
  spin(){ this.rotSpeed = 0.3 + Math.random()*0.8; }
  update(dt){ if(this.rotSpeed>0){ this.wheel.rotation.z += this.rotSpeed; this.rotSpeed *= 0.992; if(this.rotSpeed<0.001) { this.rotSpeed=0; const idx = Math.floor(((this.wheel.rotation.z%(Math.PI*2))+Math.PI*2)%(Math.PI*2) / (Math.PI*2/8)); const reward = (8-idx)%8+1; state.coins += reward; saveState(); document.getElementById('overlay').innerText='You won '+reward+' coins'; } } }
}

/* --------------------------- Snake Royale (3D) - simplified --------------------------- */
class Snake3D{
  constructor(){ this.group=new THREE.Group(); scene.add(this.group); this.body=[]; this.dir=new THREE.Vector3(0,0,1); this.makeStage(); this.createHead(); this.timer=0; this.score=0; camera.position.set(0,18,0); camera.lookAt(0,0,10); }
  makeStage(){ const floor = new THREE.Mesh(new THREE.PlaneGeometry(24,24), new THREE.MeshStandardMaterial({color:0x0b3a2f})); floor.rotation.x=-Math.PI/2; floor.receiveShadow=true; this.group.add(floor); }
  createHead(){ const head = new THREE.Mesh(new THREE.BoxGeometry(0.8,0.8,0.8), new THREE.MeshStandardMaterial({color:0xa3ffb5})); head.position.set(0,0.4,0); this.group.add(head); this.body.push(head); window.addEventListener('keydown',(e)=>{ if(e.code==='ArrowLeft') this.dir.set(-1,0,0); if(e.code==='ArrowRight') this.dir.set(1,0,0); if(e.code==='ArrowUp') this.dir.set(0,0,1); if(e.code==='ArrowDown') this.dir.set(0,0,-1); }); }
  update(dt){ this.timer+=dt; if(this.timer>0.18){ this.timer=0; const head = this.body[0]; const pos = head.position.clone().add(this.dir.clone().multiplyScalar(1)); // move
    // collision with body
    for(let i=1;i<this.body.length;i++){ if(this.body[i].position.distanceTo(pos)<0.5){ document.getElementById('overlay').innerText='Game Over'; return; } }
    // move body
    for(let i=this.body.length-1;i>0;i--){ this.body[i].position.copy(this.body[i-1].position);} head.position.copy(pos);
    // random food
    if(Math.random()<0.2){ const food = new THREE.Mesh(new THREE.SphereGeometry(0.25,8,8), new THREE.MeshStandardMaterial({emissive:0xff0000})); food.position.set((Math.random()*20-10),0.25,(Math.random()*20-10)); this.group.add(food); food.userData={isFood:true}; }
    // eat
    this.group.children.forEach((ch)=>{ if(ch.userData && ch.userData.isFood && ch.position.distanceTo(head.position)<1){ this.group.remove(ch); const newSeg = new THREE.Mesh(new THREE.BoxGeometry(0.8,0.8,0.8), new THREE.MeshStandardMaterial({color:0xa3ffb5})); const tail = this.body[this.body.length-1]; newSeg.position.copy(tail.position); this.group.add(newSeg); this.body.push(newSeg); this.score++; } }); }
  }
}

/* --------------------------- Bottle Flip --------------------------- */
class BottleFlip{
  constructor(){ this.group=new THREE.Group(); scene.add(this.group); this.bottle = this.makeBottle(); this.group.add(this.bottle); this.rot=0; this.v=0; this.state='idle'; document.getElementById('overlay').innerText='Tap to flip'; window.addEventListener('click',()=>{ if(this.state==='idle'){ this.v = 8+Math.random()*6; this.state='flying'; } }); camera.position.set(0,6,10); }
  makeBottle(){ const g=new THREE.Group(); const body=new THREE.Mesh(new THREE.CylinderGeometry(0.4,0.4,1.6,16), new THREE.MeshStandardMaterial({color:0x8bd3ff})); body.position.y=0.8; g.add(body); g.rotation.z=0; g.position.y=0.2; return g; }
  update(dt){ if(this.state==='flying'){ this.bottle.position.y += this.v*dt; this.bottle.rotation.z += this.v*dt*0.6; this.v -= 12*dt; if(this.bottle.position.y<=0.2){ // landed
        const ang = Math.abs((this.bottle.rotation.z % (Math.PI*2))); if(ang<0.5 || ang> (Math.PI*2 -0.5)){ document.getElementById('overlay').innerText='Landed upright! +3 coins'; state.coins += 3; } else { document.getElementById('overlay').innerText='Landed down'; } this.bottle.position.y=0.2; this.bottle.rotation.z=0; this.state='idle'; saveState(); }
  } }
}

/* --------------------------- Jump Dash --------------------------- */
class JumpDash{
  constructor(){ this.group=new THREE.Group(); scene.add(this.group); this.player = this.makePlayer(); this.group.add(this.player); this.platforms=[]; this.vy=0; this.score=0; this.spawnInitial(); camera.position.set(0,10,18); }
  makePlayer(){ const p=new THREE.Mesh(new THREE.BoxGeometry(0.9,0.9,0.9), new THREE.MeshStandardMaterial({color:0xffe6a7})); p.position.set(0,2,0); return p; }
  spawnInitial(){ for(let i=0;i<8;i++){ this.spawnPlatform(i*2); } }
  spawnPlatform(y){ const plat = new THREE.Mesh(new THREE.BoxGeometry(4,0.4,2), new THREE.MeshStandardMaterial({color:0x3a7})); plat.position.set((Math.random()*6-3),y,0); this.group.add(plat); this.platforms.push(plat); }
  update(dt){ this.vy -= 18*dt; this.player.position.y += this.vy*dt; if(this.player.position.y<0.8){ this.player.position.y=0.8; this.vy=8; }
    // when reach high, spawn more
    if(this.player.position.y>10){ this.score += Math.floor(this.player.position.y); }
    camera.position.y = THREE.MathUtils.lerp(camera.position.y, this.player.position.y+6, 0.06); camera.lookAt(this.player.position.x,this.player.position.y,this.player.position.z);
  }
}

/* --------------------------- Game manager --------------------------- */
const games = {
  chicken: ChickenRoad,
  aviator: MiniAviator,
  spinner: Spinner,
  snake: Snake3D,
  bottle: BottleFlip,
  jump: JumpDash
};

function startGame(id){ if(currentGame && currentGame.group) scene.remove(currentGame.group); initThree(); addDefaultLights(); currentGame = new games[id](); document.getElementById('hud').innerText = `Coins: ${state.coins}`; document.getElementById('overlay').innerText = '' }

function animate(){ requestAnimationFrame(animate); const dt = clock.getDelta(); if(currentGame && typeof currentGame.update==='function') currentGame.update(dt); renderer.render(scene,camera); document.getElementById('hud').innerText = `Coins: ${state.coins}`; }

/* --------------------------- UI Hooks --------------------------- */
document.getElementById('startBtn').addEventListener('click', ()=>{ const g = document.getElementById('gameSelect').value; startGame(g); if(!clock) clock=new THREE.Clock(); animate(); });

document.getElementById('resetData').addEventListener('click', ()=>{ if(confirm('Reset local scores and coins?')){ state.coins=0; state.leaderboards={}; saveState(); alert('Reset done'); } });

document.getElementById('openProfile').addEventListener('click', ()=>{
  alert('Wallet — coins: '+state.coins+'\nLeaderboards available in localStorage');
});

// populate quick menu
const menuDiv = document.getElementById('menuGames'); ['chicken','aviator','spinner','snake','bottle','jump'].forEach(k=>{ const b=document.createElement('button'); b.className='btn ghost'; b.innerText=k; b.onclick=()=>{ document.getElementById('gameSelect').value=k; startGame(k); }; menuDiv.appendChild(b); });

// initialize renderer now so the page is responsive
initThree(); addDefaultLights();

// Telegram WebApp integration (best-effort)
if(window.Telegram && window.Telegram.WebApp){ try{ const tg = window.Telegram.WebApp; tg.expand(); console.log('Running inside Telegram WebApp'); }catch(e){} }

</script></body>
</html>
